I"äU<h1 id="reductores-descripci√≥n-general">Reductores: Descripci√≥n general</h1>

<p>En Google Earth Engine (GEE), <a href="https://developers.google.com/earth-engine/reducers_intro">reducers</a> se utilizan para agregar datos en el tiempo, el espacio y otras estructuras de datos. Pertenecen a la clase <code class="language-plaintext highlighter-rouge">ee.Reducer</code> e incluyen estad√≠sticas de resumen, histogramas y regresi√≥n lineal, entre otros. Aqu√≠ se presenta una demostraci√≥n visual que muestra un reductor aplicado a una <code class="language-plaintext highlighter-rouge">ImageCollection</code>:</p>

<p><br />
<img src="../fig/04_reducers.png" border="10" />
<br /><br /></p>

<p>Las reducciones tambi√©n pueden ocurrir en el espacio, sobre las bandas dentro de una imagen, o sobre los atributos de una <code class="language-plaintext highlighter-rouge">FeatureCollection</code>. Ver el <a href="https://developers.google.com/earth-engine/reducers_intro">Reducer Overview</a> en la Gu√≠a del Desarrollador de Google para m√°s informaci√≥n.</p>

<p>En el M√≥dulo 03: Accediendo al Cat√°logo de Im√°genes de Sat√©lite, usamos un l√≠mite vectorial y un rango de fechas para filtrar una colecci√≥n de im√°genes, aplicamos un algoritmo (NDVI) sobre esa colecci√≥n, y luego la redujimos a una imagen en la que cada valor de p√≠xel era su m√°ximo NDVI. Aqu√≠ seguimos el mismo flujo de trabajo, pero en su lugar reduciremos usando <code class="language-plaintext highlighter-rouge">imageCollection.sum()</code> para calcular la precipitaci√≥n anual total para cada p√≠xel en los EE.UU. (reductores temporales). Luego daremos un paso m√°s y usaremos el reductor espacial ‚ÄòreduceRegions‚Äô para calcular la precipitaci√≥n anual total para cada condado de los EE.UU.</p>

<h1 id="ejercicio-obtener-datos-clim√°ticos-desde-gee">Ejercicio: Obtener datos clim√°ticos desde GEE</h1>
<p>Aqu√≠ demostraremos c√≥mo aplicar un reductor temporal y espacial para obtener datos de precipitaci√≥n anual por condado para los EE.UU.</p>

<h3 id="el-cat√°logo-de-datos-de-gee">El cat√°logo de datos de GEE</h3>
<p>Un objetivo secundario de este ejercicio es utilizar GEE para acceder a bases de datos comunes almacenados en archivo que puedan resultar atractivos para quienes no est√©n directamente relacionados con el sensoramiento remoto. Como se describe en la <a href="https://hasencios.github.io/GEE_BASICO_SENAMHI/01-introduction/">Introducci√≥n</a>, GEE provee diferentes bases de datos pertinentes para los an√°lisis de los sistemas terrestres. El archivo completo puede ser consultado <a href="https://code.earthengine.google.com/datasets/">here</a>. En este ejercicio, usaremos el <a href="https://code.earthengine.google.com/dataset/IDAHO_EPSCOR/GRIDMET">GRIDMET Meteorological Dataset</a> para obtener precipitaciones. GRIDMET combina PRISM y NLDAS para producir una base de datos clim√°ticos diarios, en grillas de 4 km, para los Estados Unidos desde 1979 hasta el presente.</p>

<h3 id="temporal-reducer-generar-un-image-statistics-en-el-tiempo">Temporal Reducer: Generar un Image Statistics en el tiempo</h3>
<p>Tal como se discuti√≥ en el <a href="https://hasencios.github.io/GEE_BASICO_SENAMHI/03-load-imagery/">m√≥dulo Accediendo al cat√°logo de im√°genes de sat√©lite
</a>, una <code class="language-plaintext highlighter-rouge">ImageCollection</code> es una pila o serie temporal de im√°genes. Los reductores se usan para derivar una sola <code class="language-plaintext highlighter-rouge">Image</code> basada en la <code class="language-plaintext highlighter-rouge">ImageCollection</code>. Las operaciones ocurren en por p√≠xeles. Seguiremos este flujo de trabajo:</p>

<ul>
  <li>‚ÄúLoad‚Äù los datos de la GRIDMET como una <code class="language-plaintext highlighter-rouge">ImageCollection</code></li>
  <li>Filtrar la banda de datos de precipitaciones y las fechas deseadas</li>
  <li><strong>Reduce</strong> 365 im√°genes ‚Äúraster‚Äù de precipitaciones diarias en una imagen ‚Äúraster‚Äù de totales de precipitaciones anuales (suma de rasters por p√≠xel)</li>
  <li>Visualizar el resultado</li>
</ul>

<h4 id="cargar-y-filtrar-una-imagecollection">Cargar y filtrar una ImageCollection</h4>
<p>Primero, necesitamos identificar el <strong>ImageCollection ID</strong> para el producto de datos GRIDMET y el <strong>band name</strong> para los datos de precipitaci√≥n (y comprobar cualquier metadato relevante). Esto se puede encontrar en el <a href="https://code.earthengine.google.com/datasets/">data catalog</a> o directamente en el <a href="https://code.earthengine.google.com/">GEE Code Editor</a> en la parte superior del panel central.</p>

<p>Para la <a href="https://code.earthengine.google.com/dataset/IDAHO_EPSCOR/GRIDMET">GRIDMET description</a>, sabemos que el ID de ImageCollection = ‚ÄòIDAHO_EPSCOR/GRIDMET‚Äô y el nombre de la banda de precipitaci√≥n es ‚Äòpr‚Äô. Espec√≠ficamente <code class="language-plaintext highlighter-rouge">select</code> esta banda solamente.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// load precip data (mm, daily total): 365 images per year</span>
<span class="kd">var</span> <span class="nx">precipCollection</span> <span class="o">=</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">ImageCollection</span><span class="p">(</span><span class="dl">'</span><span class="s1">IDAHO_EPSCOR/GRIDMET</span><span class="dl">'</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="dl">'</span><span class="s1">pr</span><span class="dl">'</span><span class="p">)</span>   <span class="c1">// select  precip band only</span>
                    <span class="p">.</span><span class="nx">filterDate</span><span class="p">(</span><span class="dl">'</span><span class="s1">2017-01-01</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">2017-12-31</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="nx">precipCollection</span><span class="p">,</span> <span class="dl">'</span><span class="s1">precipCollection</span><span class="dl">'</span><span class="p">);</span></code></pre></figure>

<p>Al imprimir la colecci√≥n resultante en la consola, podemos ver que hemos accedido a 365 im√°genes, cada una con una banda llamada ‚Äòpr‚Äô.</p>

<h4 id="aplicar-un-sum-reducer-y-visualizar-los-resultados">Aplicar un Sum Reducer y visualizar los resultados</h4>
<p>El operador <code class="language-plaintext highlighter-rouge">imageCollection.reduce()</code> permite aplicar cualquier funci√≥n de la clase <code class="language-plaintext highlighter-rouge">ee.Reducer()</code> a todas las im√°genes de la colecci√≥n. Si tu <code class="language-plaintext highlighter-rouge">ImageCollection</code> ten√≠a m√∫ltiples bandas, el reductor se aplica por separado a todas las bandas (a menos que el reductor utilice m√∫ltiples bandas como entradas, en cuyo caso el n√∫mero de bandas de la colecci√≥n de im√°genes debe coincidir con el n√∫mero de entradas que requiere el reductor). Puede encontrar los reductores disponibles y sus descripciones en la referencia de la API que se puede buscar en la pesta√±a <strong>Docs</strong> en el panel superior izquierdo del Code Editor.</p>

<p><br />
<img src="../fig/04_reducerMenu.PNG" border="10" />
<br /><br /></p>

<p>Algunos reductores com√∫nmente usados tienen una sintaxis abreviada, como <code class="language-plaintext highlighter-rouge">imageCollection.mean()</code>, <code class="language-plaintext highlighter-rouge">imageCollection.min()</code>, y convenientemente, <code class="language-plaintext highlighter-rouge">imageCollection.sum()</code>. Ambas sintaxis se demuestran en el siguiente fragmento de c√≥digo.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// load precip data (mm, daily total): 365 images per year</span>
<span class="kd">var</span> <span class="nx">precipCollection</span> <span class="o">=</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">ImageCollection</span><span class="p">(</span><span class="dl">'</span><span class="s1">IDAHO_EPSCOR/GRIDMET</span><span class="dl">'</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="dl">'</span><span class="s1">pr</span><span class="dl">'</span><span class="p">)</span>   <span class="c1">// select  precip band only</span>
                    <span class="p">.</span><span class="nx">filterDate</span><span class="p">(</span><span class="dl">'</span><span class="s1">2017-01-01</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">2017-12-31</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="nx">precipCollection</span><span class="p">);</span>  

<span class="c1">// reduce the image collection to one image by summing the 365 daily rasters</span>
<span class="kd">var</span> <span class="nx">annualPrecip</span> <span class="o">=</span> <span class="nx">precipCollection</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">ee</span><span class="p">.</span><span class="nx">Reducer</span><span class="p">.</span><span class="nx">sum</span><span class="p">());</span>
<span class="nx">print</span><span class="p">(</span><span class="nx">annualPrecip</span><span class="p">);</span>

<span class="c1">// equivalent shortcut syntax</span>
<span class="kd">var</span> <span class="nx">annualPrecip2</span> <span class="o">=</span> <span class="nx">precipCollection</span><span class="p">.</span><span class="nx">sum</span><span class="p">();</span>

<span class="c1">// visualize annual precipitation</span>
<span class="kd">var</span> <span class="nx">precipPal</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">white</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">blue</span><span class="dl">'</span><span class="p">]</span> <span class="c1">// store palette as variable               </span>
<span class="nb">Map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">annualPrecip</span><span class="p">,</span> <span class="p">{</span><span class="na">min</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="na">max</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="na">palette</span><span class="p">:</span> <span class="nx">precipPal</span><span class="p">},</span> <span class="dl">'</span><span class="s1">precip</span><span class="dl">'</span><span class="p">);</span></code></pre></figure>

<p>Al imprimir la imagen resultante en la consola, podemos ver que ahora tenemos una imagen con una banda llamada ‚Äòpr_sum‚Äô. Esto es lo que parece:</p>

<p><br />
<img src="../fig/04_annualPrecipMap.PNG" border="10" />
<br /><br /></p>

<h3 id="spatial-reducer-generar-un-image-statistics-por-regiones">Spatial Reducer: Generar un Image Statistics por regiones</h3>
<p>Ahora tomemos la imagen de la precipitaci√≥n anual que acabamos de crear y obtengamos la precipitaci√≥n media areal por condado en los Estados Unidos. Para obtener las estad√≠sticas de la imagen para m√∫ltiples regiones, podemos usar una funci√≥n <a href="https://developers.google.com/earth-engine/reducers_reduce_regions">image.reduceRegions()</a>. Usaremos una <a href="https://developers.google.com/earth-engine/feature_collections">FeatureCollection</a> para almacenar nuestra base de datos vectorial de los condados. Tengan en cuenta que tambi√©n hay un operador <a href="https://developers.google.com/earth-engine/reducers_reduce_region">image.reduceRegion()</a> si quer√≠a resumir una regi√≥n del pol√≠gono solamente. El resultado de la operaci√≥n <code class="language-plaintext highlighter-rouge">reduceRegiones()</code> se a√±ade a las propiedades de cada caracter√≠stica en la <code class="language-plaintext highlighter-rouge">FeatureCollection</code>.</p>

<blockquote>
  <p>*Una nota importante sobre el par√°metro de escala**</p>
</blockquote>

<blockquote>
  <p>GEE utiliza una evaluaci√≥n de su c√≥digo que s√≥lo ejecuta las partes de su script necesarias para los resultados esperados - en el caso del entorno de la API de JavaScript. <em>GEE ejecutar√° sus c√°lculos con la resoluci√≥n de su vista actual del mapa en el Code Editor, a menos que usted le diga lo contrario</em>. Siempre que sea posible, establezca expl√≠citamente los argumentos de escala para forzar a GEE a trabajar en una escala que tenga sentido para sus im√°genes/an√°lisis. Lea el wiki <a href="https://en.wikipedia.org/wiki/Modifiable_areal_unit_problem">modifiable areal unit problem</a> o el <a href="https://developers.google.com/earth-engine/scale">Developers Docs</a> para observar porque esto es importante.</p>
</blockquote>

<h4 id="cargar-los-l√≠mites-de-pa√≠ses-data-vectorial">Cargar los l√≠mites de pa√≠ses (Data Vectorial)</h4>

<p>Hay tres maneras de obtener datos de vectores en GEE, como se examina en el <a href="https://hasencios.github.io/GEE_BASICO_SENAMHI/03-load-imagery/">m√≥dulo 03 Accediendo al cat√°logo de im√°genes de sat√©lite
</a>. Aqu√≠ usaremos un <a href="https://fusiontables.google.com/data?docid=1xdysxZ94uUFIit9eXmnw1fYc6VcQiXhceFd_CVKa#map:id=2">existing public fusion table of county boundaries</a> de la Oficina del Censo de los Estados Unidos.</p>

<p>Este base de datos incluye entidades fuera de los Estados Unidos como Alaska, Puerto Rico y Samoa Americana. Las eliminaremos bas√°ndonos en sus ID en un atributo de propiedad que contiene c√≥digos FIPS ‚Äústate‚Äù para demostrar el filtrado de vectores.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// load regions: counties from a public fusion table, removing non-conus states</span>
<span class="c1">// by using a custom filter</span>
<span class="kd">var</span> <span class="nx">nonCONUS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">66</span><span class="p">,</span><span class="mi">69</span><span class="p">,</span><span class="mi">72</span><span class="p">,</span><span class="mi">78</span><span class="p">]</span> <span class="c1">// state FIPS codes that we don't want</span>
<span class="kd">var</span> <span class="nx">counties</span> <span class="o">=</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">FeatureCollection</span><span class="p">(</span><span class="dl">'</span><span class="s1">ft:1ZMnPbFshUI3qbk9XE0H7t1N5CjsEGyl8lZfWfVn4</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">ee</span><span class="p">.</span><span class="nx">Filter</span><span class="p">.</span><span class="nx">inList</span><span class="p">(</span><span class="dl">'</span><span class="s1">STATEFP</span><span class="dl">'</span><span class="p">,</span><span class="nx">nonCONUS</span><span class="p">).</span><span class="nx">not</span><span class="p">());</span>
<span class="nx">print</span><span class="p">(</span><span class="nx">counties</span><span class="p">,</span> <span class="dl">'</span><span class="s1">counties</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// visualize</span>
<span class="nb">Map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">counties</span><span class="p">,{},</span><span class="dl">'</span><span class="s1">counties</span><span class="dl">'</span><span class="p">);</span>  </code></pre></figure>

<p>Al imprimir el featureCollection, vemos que hay 3108 pol√≠gonos de condado y 11 columnas de datos de atributos.</p>

<p><br />
<img src="../fig/04_countyMap.png" border="10" />
<br /><br /></p>

<h4 id="aplicar-el-spatial-reducer">Aplicar el spatial reducer</h4>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// get mean precipitation values by county polygon</span>
<span class="kd">var</span> <span class="nx">countyPrecip</span> <span class="o">=</span> <span class="nx">annualPrecip</span><span class="p">.</span><span class="nx">reduceRegions</span><span class="p">({</span>
  <span class="na">collection</span><span class="p">:</span> <span class="nx">counties</span><span class="p">,</span>
  <span class="na">reducer</span><span class="p">:</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">Reducer</span><span class="p">.</span><span class="nx">mean</span><span class="p">(),</span>
  <span class="na">scale</span><span class="p">:</span> <span class="mi">4000</span> <span class="c1">// the resolution of the GRIDMET dataset</span>
<span class="p">});</span>
<span class="nx">print</span><span class="p">(</span><span class="nx">countyPrecip</span><span class="p">);</span></code></pre></figure>

<p>Al imprimir la featureCollection countyPrecip, vemos que hay 3108 pol√≠gonos de condado y ahora 12 columnas de datos de atributos, con la adici√≥n de la columna ‚Äúmean‚Äù.</p>

<h3 id="acondicionar-los-resultados-para-exportarlos">Acondicionar los resultados para exportarlos</h3>
<p>GEE puede exportar tablas en CSV (default), GeoJSON, KML o KMZ. Aqu√≠, hacemos un peque√±o formateo para preparar nuestra FeatureCollection para exportar como CSV.</p>

<p>El formato incluye:</p>

<ul>
  <li>Eliminar la columna .geo para un conjunto de datos m√°s ordenado (esta columna puede ser bastante grande cuando los pol√≠gonos son muy detallados, pero no hay raz√≥n para que tengas que hacer este paso)</li>
  <li>A√±adir un atributo de columna para el a√±o de los datos del precipitaci√≥n para demostrar la manipulaci√≥n de los atributos. Esto s√≥lo se puede hacer con las Features, por lo que asignamos una funci√≥n para hacer esto sobre las Features dentro de la  Feature Collection</li>
</ul>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// drop .geo column (not needed if goal is tabular data)</span>
<span class="kd">var</span> <span class="nx">polyOut</span> <span class="o">=</span> <span class="nx">countyPrecip</span><span class="p">.</span><span class="nx">select</span><span class="p">([</span><span class="dl">'</span><span class="s1">.*</span><span class="dl">'</span><span class="p">],</span><span class="kc">null</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>

<span class="c1">// add a new column for year to each feature in the feature collection</span>
<span class="nx">polyOut</span> <span class="o">=</span> <span class="nx">polyOut</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">feature</span><span class="p">){</span>
<span class="k">return</span> <span class="nx">feature</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Year</span><span class="dl">'</span><span class="p">,</span><span class="mi">2017</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Table to Drive Export Example</span>

<span class="nx">Export</span><span class="p">.</span><span class="nx">table</span><span class="p">.</span><span class="nx">toDrive</span><span class="p">({</span>
  <span class="na">collection</span><span class="p">:</span> <span class="nx">polyOut</span><span class="p">,</span>
  <span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">GRIDMET_annual_precip_by_county</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">folder</span><span class="p">:</span> <span class="dl">'</span><span class="s1">GEE_geohackweek</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">fileFormat</span><span class="p">:</span> <span class="dl">'</span><span class="s1">CSV</span><span class="dl">'</span>
<span class="p">});</span>   

<span class="c1">// AND HIT 'RUN' IN THE TASKS TAB IN THE UPPER RIGHT PANEL</span></code></pre></figure>

<p>Nota sobre el nombre de la carpeta: si esta carpeta existe dentro de su unidad de Google, GEE la encontrar√° y exportar√° aqu√≠ independientemente de la ruta completa de su archivo. Si la carpeta no existe, GEE la crear√° al momento de la exportaci√≥n.</p>

<h3 id="comenzar-a-exportar">Comenzar a Exportar</h3>

<p>Para poder exportar realmente tus datos, tienes que pulsar expl√≠citamente el bot√≥n ‚ÄúRun‚Äù bajo la pesta√±a ‚ÄúTask‚Äù en el panel superior derecho del Code Editor. La exportaci√≥n deber√≠a tomar 20-30 segundos, dependiendo de las cargas de los usuarios de GEE.</p>

<p>Se ha a√±adido una nueva y √∫til funci√≥n en la que se puede mantener el rat√≥n sobre el lado derecho de la tarea completada y hacer clic en el signo de interrogaci√≥n para abrir una ventana con los detalles de la tarea como en el diagrama siguiente.</p>

<p><br />
<img src="../fig/04_runTask.png" border="10" width="50%" height="50%" />
<br /><br /></p>

<p>Enlace a una versi√≥n est√°tica del script completo usado en este m√≥dulo:
<a href="https://code.earthengine.google.com/89436bb293b0dc412ed813499a820fe1">https://code.earthengine.google.com/89436bb293b0dc412ed813499a820fe1</a></p>
:ET